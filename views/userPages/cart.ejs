<%-include('../partials/user/header.ejs')%>

<style>
  body {
    background-color: #fff;
    font-family: Arial, sans-serif;
  }
  .shopping-bag-title {
    font-weight: bold;
    text-align: center;
    margin: 30px 0;
    font-size: 1.8rem;
    letter-spacing: 2px;
  }
  .card {
    border: none;
  }
  .item-img {
    max-width: 100px;
  }
  .order-summary {
    background: #f5f5f5;
    padding: 20px;
    border-radius: 6px;
  }
  .order-summary h5 {
    font-weight: bold;
    margin-bottom: 20px;
  }
  .order-summary .summary-line {
    display: flex;
    justify-content: space-between;
    margin-bottom: .5rem;
  }
  .summary-line{
    font-size: x-small;
  }

  .apply-btn {
    background: black;
    color: white;
    border: none;
  }
  .in-stock {
    color: green;
    font-size: 0.9rem;
  }
  .remove-btn {
    font-size: 0.85rem;
    color: red;
    background: none;
    border: none;
    padding: 0;
    text-decoration: underline;
    cursor: pointer;
  }
</style>

<main>
  <div class="container">
    <div class="shopping-bag-title">SHOPPING BAG</div>
    <div class="row">
      <!-- Left Side: Shopping Items -->
       <%if(items.length>0) {%>
      <div class="col-lg-9">
        <% let total = 0; %> <% items.forEach((item,index) => { let lineTotal =
        (item.variant.discount-1)* item.quantity; total += lineTotal; %>
        <div class="card mb-4 p-3 shadow-sm">
          <div class="row align-items-center">
            <div class="col-md-2">
              <a href="/products/<%=item.product._id%>">
              <img
                src="<%= item.product.images[0] %>"
                class="img-fluid item-img rounded-4"
                alt="<%= item.product.name %>"
              />
              </a>
            </div>
            <div class="col-md-6">
              <h6 class="mb-1"><%= item.product.name %></h6>
              <small><%= item.variant.volume %> ML</small>
              <p class="mt-2 mb-0">
                Shipping<br />
                <span class="text-muted">Arrives in 3–5 business days </span>
                <% if(item.variant.stock > 0){ %>
                <span class="in-stock">In stock</span>
                <% } else { %>
                <span class="text-danger">Out of stock</span>
                <% } %>
              </p>
              <small class="text-muted">Free Delivery</small><br />
            </div>
            <div class="col-md-4 text-end">
              <p class="fw-bold">Rs.<%= item.variant.discount-1 %></p>
              <div class="d-flex align-items-center justify-content-end mb-3">
                <button
                  class="btn btn-outline-secondary btn-sm me-2 decrease"
                  data-cart-id="<%= item._id %>"
                >
                  -
                </button>
                <span><%= item.quantity %></span>
                <button
                  class="btn btn-outline-secondary btn-sm ms-2 increase"
                  data-cart-id="<%= item._id %>"
                >
                  +
                </button>
              </div>
              <p class="text-muted mb-1">Subtotal: Rs.<%= lineTotal %></p>
              <!-- Remove button -->
              <form
                action="/cart/remove/<%= item._id %>?_method=DELETE"
                method="POST"
                class="d-block"
              >
                <button
                  type="submit"
                  class="btn btn-dark py-1 px-2 text-end"
                  style="font-size: small">
                  Remove
                </button>
              </form>
            </div>
          </div>
        </div>
        <% }) %>
      </div>

      <!-- Right Side: Order Summary -->
      <div class="col-md-3">
        <div class="order-summary shadow-sm">
          <h5>Order Summary</h5>

          <% items.forEach((item)=>{ %>
          <div class="summary-line">
            <span
              ><%= item.quantity %> × <%= item.product.name %> (<%=
              item.variant.volume %>ml)</span
            >
            <span
              >Rs.<%= ((item.variant.discount-1) *
              item.quantity).toLocaleString() %></span
            >
          </div>
          <% }) %>

          <div class="summary-line text-success">
            <span>Delivery Charges</span><span>Free</span>
          </div>

          <div class="summary-line fw-bold fs-5">
            <span>Total</span><span>Rs.<%= total.toLocaleString() %></span>
          </div>
          <a href="/checkout/address" class="btn btn-dark text-decoration-none">CONTINUE TO CHECKOUT</a>
        </div>
      </div>
      <%}else{%>
        <div class="col-12 text-center my-5">
    <img src="/images/f76be7b5-3b78-43fb-a0a6-b0543c1f2b5a.png" alt="Empty Cart" class="img-fluid mb-4" style="max-width:300px;">
    <h4 class="mb-3">Your cart is empty</h4>
    <p class="text-muted">Looks like you haven’t added anything to your cart yet.</p>
    <a href="/shop" class="btn btn-dark mt-3">Start Shopping</a>
  </div>
      <%}%>
    </div>
  </div>
</main>
<script>
  document.querySelectorAll(".increase").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const cartId = btn.dataset.cartId; // get cartId from button
      const quantitySpan = btn.previousElementSibling;

      try {
        const res = await fetch(`/cart/increase/${cartId}`, {
          method: "PATCH",
        });
        const data = await res.json();

        if (data.success) {
          quantitySpan.textContent = data.newQuantity;
          const lineTotalElem = btn
            .closest(".col-md-4")
            .querySelector("p.text-muted.mb-1");
          lineTotalElem.textContent = `Subtotal: Rs.${data.lineTotal}.99`;
          document.querySelector(
            ".summary-line.fw-bold.fs-5 span:last-child"
          ).textContent = `Rs.${data.total}`;
        }
      } catch (err) {
        console.error(err);
      }
    });
  });

  document.querySelectorAll(".decrease").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const cartId = btn.dataset.cartId;
      const quantitySpan = btn.nextElementSibling;

      try {
        const res = await fetch(`/cart/decrease/${cartId}`, {
          method: "PATCH",
        });
        const data = await res.json();

        if (data.success) {
          quantitySpan.textContent = data.newQuantity;
          const lineTotalElem = btn
            .closest(".col-md-4")
            .querySelector("p.text-muted.mb-1");
          lineTotalElem.textContent = `Subtotal: Rs.${data.lineTotal}.99`;
          document.querySelector(
            ".summary-line.fw-bold.fs-5 span:last-child"
          ).textContent = `Rs.${data.total}`;
        }
      } catch (err) {
        console.error(err);
      }
    });
  });
</script>

<%-include('../partials/user/footer.ejs')%>
