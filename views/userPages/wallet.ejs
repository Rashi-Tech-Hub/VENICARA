<%- include('../partials/user/header.ejs') %> <%-
include('../partials/user/sidebarProfile.ejs') %>

<style>
  .wallet-card {
    width: 65%;
  }
  .add-input {
    border: none;
    text-align: center;
    padding: 1.5rem 0;
    font-size: 25px;
    font-weight: bolder;
    background:rgb(240, 240, 240)
  }
  .add-input:focus-visible {
    outline: none !important;
  }

</style>

<main class="w-100 justify-content-center d-flex">
  <div class="card rounded-5 px-5 py-4 shadow wallet-card">
    <div class="row">
      <div class="col-md-12 text-center">
        <p class="fs-2 fw-bold mt-1">MY WALLET</p>
      </div>

      <!-- BALANCE -->
      <div
        class="col-md-12 container rounded-3 p-3 border-1"
        style="background: rgb(240, 240, 240)"
      >
        <span class="fs-5 fw-bold">TOTAL BALANCE</span>
        <hr/>
        <span class="d-flex justify-content-between align-items-center p-3">
          <span class="fs-5 fw-semibold">WALLET</span>
          <span class="text-success fs-3 fw-semibold" id="balance">₹<%=Math.round(wallet?.balance)%></span>
        </span>
      </div>

      <!-- ADD MONEY -->
      <div
        class="col-md-12 container rounded-3 p-3 border-1 mt-3"
        style="background: rgb(240, 240, 240)"
      >
        <span class="fs-5 fw-bold">ADD TO WALLET</span>
        <hr />
        <form id="walletForm" action="#" method="POST">
          <div class="text-center p-1">
            <input
              type="text"
              id="amount"
              name="amount"
              class="add-input rounded-3"
              value="₹"
              maxlength="10"
              placeholder="Amount"
            />
          </div>

          <div class="text-center p-2">
            <button
              type="button"
              class="btn btn-outline-dark preset-btn"
              data-value="100"
            >
              ₹100
            </button>
            <button
              type="button"
              class="btn btn-outline-dark preset-btn"
              data-value="200"
            >
              ₹200
            </button>
            <button
              type="button"
              class="btn btn-outline-dark preset-btn"
              data-value="500"
            >
              ₹500
            </button>
          </div>

          <div class="text-center p-2">
            <button type="submit" class="btn btn-dark fw-bold">
              ADD MONEY
            </button>
          </div>
        </form>
      </div>

      <!-- TRANSACTIONS -->
      <div class="col-md-12 text-end mt-3">
        <a href="/wallet/history" class="btn-primary btn px-5 fw-semibold">Show Transaction History</a>
      </div>
    </div>
  </div>
</main>
</div>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>

      toastr.options = {
    "closeButton": true,
    "progressBar": true,
    "positionClass": "toast-top-center",
    "timeOut": "3000"
  };

  const input = document.getElementById("amount");
  const form = document.getElementById("walletForm");

  // Keep ₹ always prefixed
  input.addEventListener("input", () => {
    if (!input.value.startsWith("₹")) {
      input.value = "₹" + input.value.replace(/₹/g, "");
    }
    // Allow only numbers after ₹
    input.value = "₹" + input.value.slice(1).replace(/[^0-9]/g, "");
  });

  // Preset buttons
  document.querySelectorAll(".preset-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      input.value = "₹" + btn.dataset.value;
    });
  });

  // On form submit -> send only numbers (without ₹)
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const amountValue = input.value.replace("₹", "").trim();

    // Basic validation
    if (!amountValue || isNaN(amountValue) || parseInt(amountValue) <= 0) {
      alert("Please enter a valid amount.");
      return;
    }

    try {
      // Step 1: Create Razorpay Order from backend
      const res = await fetch("/wallet/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount: amountValue }),
      });

      const {order} = await res.json();

      if (!order || !order.id || order.status !== "created") {
        alert("Failed to create order. Try again.");
        return;
      }

      // Step 2: Razorpay Checkout
      const options = {
        key: "<%= process.env.RAZORPAY_KEY_ID %>", // Injected from backend
        amount: order.amount, // in paise
        currency: "INR",
        name: "Venicara Wallet",
        description: "Add Money to Wallet",
        order_id: order.id,
        handler: async function (response) {
          try {
            // Step 3: Verify payment on backend
            const verifyRes = await fetch("/wallet/verify-payment", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(response),
            });

            const verifyData = await verifyRes.json();
            if (verifyData.status) {
              document.getElementById('balance').textContent = `₹${verifyData.balance}`
            } else {
              alert("Payment verification failed!");
            }
          } catch (err) {
            console.error(err);
            alert("Verification error. Try again.");
          }
        },
        theme: { color: "#121212" },
      };

      const rzp = new Razorpay(options);
      rzp.open();
    } catch (error) {
      console.error(error);
      toastr.error("Something went wrong. Try again later.");
    }
  });
</script>
</body>
</html>